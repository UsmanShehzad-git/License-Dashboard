<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>License Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <link rel="stylesheet" href="/static/style.css" />
    <style>
        #responseToken {
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .logout-btn {
            position: absolute;
            top: 60px;
            left: 40px;
            background-color: #f44336;
            color: white;
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .logout-btn:hover {
            background-color: #d32f2f;
        }

        /* Custom alert */
        #customAlert {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 16px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transform: translateX(120%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 9999;
        }

        #customAlert.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }

        .copy-btn {
            background-color: #444;
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #222;
        }

        .modal01 {
            display: none;
            position: fixed;
            z-index: 10;
            padding-top: 120px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content01 {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 80%;
        }

        .btn.cancel {
            background-color: #bbb;
            margin-right: 10px;
        }

        .btn.delete {
            background-color: #f44336;
            color: white;
        }

        #licenseDetailModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        #licenseDetailModal .modal-content01 {
            background-color: #fff;
            margin: 80px auto;
            padding: 30px 40px;
            border-radius: 15px;
            width: 770px;
            max-width: 950px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #222;
            position: relative;
            animation: slideDown 0.4s ease forwards;
        }

        #licenseDetailModal .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #licenseDetailModal .close:hover {
            color: #f44336;
        }

        #licenseDetailModal h3 {
            margin-bottom: 25px;
            font-size: 1.6rem;
            font-weight: bold;
            color: #222;
            text-align: center;
            letter-spacing: 1px;
        }

        #licenseDetailContent p {
            font-size: 1rem;
            margin: 12px 0;
            line-height: 1.4;
            color: #555;
        }

        #licenseDetailContent p strong {
            color: #222;
        }

        #licenseDetailContent p span {
            font-size: 15px;
        }

        #licenseDetailModal .btn.cancel {
            background-color: #f44336;
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        #licenseDetailModal .btn.cancel:hover {
            background-color: #d32f2f;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #licenseDetailContent {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 32px;
        }

        #licenseDetailContent p {
            margin: 0 0 10px 0;
        }

        #licenseDetailContent p:last-child {
            grid-column: 1 / span 2;
        }

        #detaillicensetoken {
            display: inline-block;
            max-width: 50%;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hash-cell {
            display: inline-block;
            max-width: 120px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-active {
            color: #2e7d32;
            font-weight: bold;
        }

        .status-expired {
            color: #c62828;
            font-weight: bold;
        }

        .status-inactive {
            color: #bdbd1a;
            font-weight: bold;
        }

        .btn.edit {
            background-color: #1976d2;
            color: white;
            margin: 0 4px;
        }

        .btn.edit:hover {
            background-color: #0d47a1;
        }

        #editLicenseModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        #editLicenseModal .modal-content01 {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 15px;
            width: 420px;
            max-width: 950px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #222;
            position: relative;
            animation: slideDown 0.4s ease forwards;
        }


        #editLicenseModal h3 {
            margin-bottom: 22px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #1976d2;
            text-align: center;
        }

        #editLicenseForm div {
            margin-bottom: 15px;
        }

        #editLicenseForm label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        #editLicenseForm input,
        #editLicenseForm select {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #bbb;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        #editLicenseForm .btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }

        #editLicenseForm .btn:hover {
            background: #0d47a1;
        }

        #editLicenseModal .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #editLicenseModal .close:hover {
            color: #f44336;
        }

        .date-cell {
            min-width: 140px;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <h1>License Dashboard</h1>
    <button onclick="window.location.href='/logout'" class="logout-btn">Logout</button>
    <button class="add-btn" onclick="openModal()">Add License</button>

    <!-- License Modal -->
    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <form class="license-form" novalidate>
                <input type="text" name="countrycode" placeholder="Country Code" pattern="[A-Z]+" required />
                <input type="text" name="companyname" placeholder="Company Name" pattern="[A-Za-z\s]+" required />
                <select name="license_type" required>
                    <option value="" disabled selected>Select License Type</option>
                    <option value="Reseller">Reseller</option>
                    <option value="Distributor">Distributor</option>
                </select>
                <input type="text" name="hash_value" placeholder="Hash" pattern="[0-9]+" required />
                <input type="number" name="device_limit" placeholder="Device Limit" required />
                <input type="text" name="validity" placeholder="Validity" required />
                <button type="submit">Generate License</button>
            </form>
        </div>
    </div>

    <!-- Response Modal -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResponseModal()">&times;</span>
            <h3>License Created Successfully ðŸŽ‰</h3>
            <p><strong>Company Name:</strong> <span id="responseCompany"></span></p>
            <p><strong>Valid from:</strong> <span id="responseValidfrom"></span></p>
            <p><strong>Valid till:</strong> <span id="responseValidtill"></span></p>
            <p>
                <strong>Token:</strong>
                <span id="responseToken"></span>
                <button class="copy-btn" onclick="copyToken()">Copy</button>
            </p>
        </div>
    </div>

    <!-- Alert -->
    <div id="customAlert">
        <span id="customAlertMessage"></span>
        <button class="close-btn" onclick="hideAlert()">&times;</button>
    </div>

    <!-- Delete Modal -->
    <div id="confirmDeleteModal" class="modal01">
        <div class="modal-content01">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this license?</p>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                <button class="btn cancel" onclick="closeConfirmDelete()">Cancel</button>
                <button class="btn delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- License Detail Modal -->
    <div id="licenseDetailModal">
        <div class="modal-content01">
            <span class="close" onclick="closeLicenseDetail()">&times;</span>
            <h3>License Details</h3>
            <div id="licenseDetailContent">
                <!-- Dynamic license details will go here -->
                <p><strong>Company Name:</strong> <span id="detailCompanyName"></span></p>
                <p><strong>Country Code:</strong> <span id="detailCountryCode"></span></p>
                <p><strong>License Type:</strong> <span id="detailLicenseType"></span></p>
                <p><strong>Hash:</strong> <span id="detailHashValue"></span></p>
                <p><strong>Device Limit:</strong> <span id="detailDeviceLimit"></span></p>
                <p><strong>Validity:</strong> <span id="detailValidity"></span> days</p>
                <p><strong>Valid From:</strong> <span id="detailValidfrom"></span></p>
                <p><strong>Valid Till:</strong> <span id="detailValidtill"></span></p>
                <p><strong>Email:</strong> <span id="detailEmail"></span></p>
                <p><strong>Activation :</strong> <span id="detailActivation"></span></p>
                <p><strong>License Token:</strong> <span id="detaillicensetoken"></span>
                    <button class="copy-btn" onclick="copyToken()">Copy</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Edit License Modal -->
    <div id="editLicenseModal" class="modal01">
        <div class="modal-content01">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Edit License</h3>
            <form id="editLicenseForm">
                <input type="hidden" name="license_id" id="editLicenseId" />
                <div>
                    <label>License Type:</label>
                    <select name="license_type" id="editLicenseType" required>
                        <option value="Reseller">Reseller</option>
                        <option value="Distributor">Distributor</option>
                    </select>
                </div>
                <div>
                    <label>Device Limit:</label>
                    <input type="number" name="device_limit" id="editDeviceLimit" required />
                </div>
                <div>
                    <label>Validity (days):</label>
                    <input type="number" name="validity" id="editValidity" required />
                </div>
                <button type="submit" class="btn">Update</button>
            </form>
        </div>
    </div>


    <!-- License Table -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>No#</th>
                    <th>Hash</th>
                    <th>Company</th>
                    <th>Country Code</th>
                    <th>Type</th>
                    <th>Limit</th>
                    <th>Validity</th>
                    <th>Createdat</th>
                    <th>Expiredat</th>
                    <th>Status</th>
                    <th>Activation</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="licenseTableBody">
            </tbody>
        </table>
    </div>

    <script>
        const licenseModal = document.getElementById('licenseModal');
        const responseModal = document.getElementById('responseModal');
        const alertEl = document.getElementById('customAlert');
        const alertMsg = document.getElementById('customAlertMessage');
        let alertTimeout;
        let deleteIdToConfirm = null;

        function openModal() {
            licenseModal.style.display = 'block';
        }

        function closeModal() {
            licenseModal.style.display = 'none';
        }

        function closeResponseModal() {
            responseModal.style.display = 'none';
        }

        function showAlert(message, type = 'success') {
            clearTimeout(alertTimeout);
            alertEl.style.backgroundColor = type === 'error' ? '#f44336' : '#4caf50';
            alertMsg.textContent = message;
            alertEl.classList.add('show');
            alertTimeout = setTimeout(hideAlert, 3500);
        }

        function hideAlert() {
            alertEl.classList.remove('show');
        }

        function validateLicenseForm(form) {
            const countrycode = form.countrycode.value.trim();
            const companyname = form.companyname.value.trim();
            const license_type = form.license_type.value;
            const hash_value = form.hash_value.value.trim();
            const device_limit = form.device_limit.value.trim();
            const validity = form.validity.value.trim();

            if (!countrycode.match(/^[A-Z]+$/)) {
                showAlert('Country Code must be uppercase letters only.', 'error');
                return false;
            }
            if (!companyname.match(/^[A-Za-z]+$/)) {
                showAlert('Company Name must contain only letters (no spaces).', 'error');
                return false;
            }
            if (!license_type) {
                showAlert('Please select a License Type.', 'error');
                return false;
            }
            if (!hash_value.match(/^[0-9]+$/)) {
                showAlert('Hash must be numbers only.', 'error');
                return false;
            }
            if (!device_limit.match(/^[0-9]+$/) || parseInt(device_limit) <= 0) {
                showAlert('Device Limit must be a positive number.', 'error');
                return false;
            }
            if (!validity.match(/^[0-9]+$/) || parseInt(validity) <= 0) {
                showAlert('Validity must be a positive number.', 'error');
                return false;
            }
            return true;
        }

        document.querySelector('.license-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateLicenseForm(e.target)) return;

            const formData = new FormData(e.target);
            const params = new URLSearchParams();
            formData.forEach((v, k) => params.append(k, v));

            try {
                const res = await fetch('/add_license', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });

                if (!res.ok) {
                    let msg = 'Server error';
                    try {
                        const errData = await res.json();
                        if (errData.message) {
                            msg = errData.message;
                        } else if (errData.detail) {
                            msg = Array.isArray(errData.detail)
                                ? errData.detail.map(d => d.msg).join(', ')
                                : errData.detail;
                        }
                    } catch { }
                    throw new Error(msg);
                }

                const data = await res.json();
                document.getElementById('responseCompany').textContent = data.company_name;
                document.getElementById('responseValidfrom').textContent = data.valid_from;
                document.getElementById('responseValidtill').textContent = data.valid_till;
                document.getElementById('responseToken').textContent = data.license_token;
                responseModal.style.display = 'block';
                showAlert('License created successfully!');
                e.target.reset();
                closeModal();
                await refreshLicenseTable();
            } catch (err) {
                showAlert(err.message, 'error');
            }
        });

        function copyToken() {
            const tokenText = document.getElementById('responseToken').textContent;
            navigator.clipboard.writeText(tokenText).then(() => {
                showAlert('Token copied to clipboard!');
            });
        }

        window.onclick = (e) => {
            if (e.target === licenseModal) closeModal();
            if (e.target === responseModal) closeResponseModal();
            if (e.target === document.getElementById('confirmDeleteModal')) closeConfirmDelete();
            if (e.target === document.getElementById('licenseDetailModal')) closeLicenseDetail();
            if (e.target === document.getElementById('editLicenseModal')) closeEditModal();
        };
        window.onload = function () {
            refreshLicenseTable();
        };


        async function refreshLicenseTable() {
            const tbody = document.getElementById('licenseTableBody');
            tbody.innerHTML = `
                <tr id="loadingIndicator">
                    <td colspan="9" style="text-align:center; padding: 40px 0;">
                        <span>Loading...</span>
                    </td>
                </tr>
            `;

            try {
                const res = await fetch('/get_licenses');
                if (res.status === 401) {
                    window.location.href = '/';
                    return;
                }
                if (!res.ok) throw new Error('Failed to fetch licenses');
                const licenses = await res.json();
                tbody.innerHTML = '';

                if (licenses.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align:center; color:#888; font-size:1.1em;">
                            No data found
                        </td>
                    </tr>
                `;
                    return;
                }

                licenses.forEach((license, idx) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${license.id}</td>
                    <td class="hash-cell">${license.hash_value}</td>
                    <td>${license.companyname}</td>
                    <td>
                        <img src="https://flagcdn.com/24x18/${license.countrycode.toLowerCase()}.png"  
                        style="vertical-align:middle; margin-right:6px;" />
                        ${license.countrycode}
                    </td>
                    <td>${license.license_type}</td>
                    <td>${license.device_limit}</td>
                    <td>${license.validity}days</td>
                    <td class="date-cell">${license.valid_from}</td>
                    <td class="date-cell">${license.valid_till}</td>
                    <td class="status-${license.status.toLowerCase()}">${license.status}</td>
                    <td class="date-cell">${license.activation_time ? license.activation_time : ''}</td>
                    <td>${license.activated_by ? license.activated_by : ''}</td>
                    <td class="actions">
                        <button class="btn view" onclick="viewDetail('${license.id}')"><i class="fa-solid fa-eye"></i></button>
                        <button class="btn edit" onclick="openEditModal('${license.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn delete" onclick="openConfirmDelete('${license.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        let editLicenseId = null;

        function openEditModal(id) {
            fetch(`/view_license/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch license details');
                    return res.json();
                })
                .then(data => {
                    editLicenseId = id;
                    document.getElementById('editLicenseId').value = id;
                    document.getElementById('editLicenseType').value = data.license_type;
                    document.getElementById('editDeviceLimit').value = data.device_limit;
                    document.getElementById('editValidity').value = data.validity;
                    document.getElementById('editLicenseModal').style.display = 'block';
                })
                .catch(err => {
                    showAlert(err.message, 'error');
                });
        }

        function closeEditModal() {
            document.getElementById('editLicenseModal').style.display = 'none';
            editLicenseId = null;
        }

        document.getElementById('editLicenseForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const license_id = document.getElementById('editLicenseId').value;
            const license_type = document.getElementById('editLicenseType').value;
            const device_limit = document.getElementById('editDeviceLimit').value;
            const validity = document.getElementById('editValidity').value;

            try {
                const res = await fetch(`/edit_license/${license_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `license_type=${encodeURIComponent(license_type)}&device_limit=${encodeURIComponent(device_limit)}&validity=${encodeURIComponent(validity)}`
                });
                if (!res.ok) {
                    let msg = 'Server error';
                    try {
                        const errData = await res.json();
                        if (errData.message) {
                            msg = errData.message;
                        } else if (errData.detail) {
                            msg = Array.isArray(errData.detail)
                                ? errData.detail.map(d => d.msg).join(', ')
                                : errData.detail;
                        }
                    } catch { }
                    throw new Error(msg);
                }
                const data = await res.json();
                document.getElementById('responseCompany').textContent = data.company_name;
                document.getElementById('responseValidfrom').textContent = data.valid_from;
                document.getElementById('responseValidtill').textContent = data.valid_till;
                document.getElementById('responseToken').textContent = data.license_token;
                responseModal.style.display = 'block';
                e.target.reset();
                closeModal();
                showAlert('License updated successfully!');
                closeEditModal();
                await refreshLicenseTable();
            } catch (err) {
                showAlert(err.message, 'error');
            }
        });

        function openConfirmDelete(id) {
            deleteIdToConfirm = id;
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function closeConfirmDelete() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
            deleteIdToConfirm = null;
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteIdToConfirm) return;

            try {
                const res = await fetch(`/delete_license/${deleteIdToConfirm}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error('Failed to delete license');

                const data = await res.json();
                showAlert(data.message);
                await refreshLicenseTable();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            } finally {
                closeConfirmDelete();
            }
        });

        function viewDetail(id) {
            fetch(`/view_license/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch license details');
                    return res.json();
                })
                .then(data => {
                    document.getElementById('detailCompanyName').textContent = data.companyname || '-';
                    document.getElementById('detailCountryCode').textContent = data.countrycode || '-';
                    document.getElementById('detailLicenseType').textContent = data.license_type || '-';
                    document.getElementById('detailHashValue').textContent = data.hash_value || '-';
                    document.getElementById('detailDeviceLimit').textContent = data.device_limit || '-';
                    document.getElementById('detailValidity').textContent = data.validity || '-';
                    document.getElementById('detailValidfrom').textContent = data.valid_from || '-';
                    document.getElementById('detailValidtill').textContent = data.valid_till || '-';
                    document.getElementById('detailEmail').textContent = data.activated_by || '-';
                    document.getElementById('detailActivation').textContent = data.activation_time || '-';
                    document.getElementById('detaillicensetoken').textContent = data.token || '-';

                    document.getElementById('licenseDetailModal').style.display = 'block';
                })
                .catch(err => {
                    showAlert('Error: ' + err.message, 'error');
                });
        }

        function closeLicenseDetail() {
            document.getElementById('licenseDetailModal').style.display = 'none';
        }

    </script>
</body>

</html>